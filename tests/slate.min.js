"use strict";class Slate{constructor(e,t,r,i,n=Slate.NO_LOCK_HEIGHT,s=SlateKernel.NO_RELATIVE_HEIGHT,a=Slate.NO_TIME_TO_LIVE_CUT_OFF_HEIGHT,o=Slate.NO_SENDER_ADDRESS,u=Slate.NO_RECEIVER_ADDRESS,g=[]){if(this.reset(),!0===Object.isObject(e)){var l=e;this.unserialize(l,t)}else{var c=e;this.amount=c,this.fee=r,this.height=i,this.lockHeight=n,this.timeToLiveCutOffHeight=a,this.senderAddress=o,this.receiverAddress=u,this.kernels.push(new SlateKernel(this.getKernelFeatures(),r,n,s,SlateKernel.ZERO_EXCESS,SlateKernel.ZERO_EXCESS_SIGNATURE)),this.blockHeaderVersion=Consensus.getHeaderVersion(t,this.getHeight()),this.version=this.minimumCompatibleVersion(g)}}serialize(e){switch(this.getVersion().toFixed()){case Slate.VERSION_TWO.toFixed():case Slate.VERSION_THREE.toFixed():var t=this,r={amount:this.getAmount().toFixed(),fee:this.getFee().toFixed(),height:this.getHeight().toFixed(),id:this.getId().serialize(),lock_height:this.getLockHeight().toFixed(),num_participants:this.getNumberOfParticipants(),participant_data:this.getParticipants().map((function(e){return e.serialize(t)})),tx:{body:{inputs:this.getInputs().map((function(e){return e.serialize(t)})),kernels:this.getKernels().map((function(e){return e.serialize(t)})),outputs:this.getOutputs().map((function(e){return e.serialize(t)}))},offset:Common.toHexString(this.getOffset())},version_info:{block_header_version:this.getBlockHeaderVersion(),orig_version:this.getOriginalVersion(),version:this.getVersion()}};if(!0===this.getVersion().isGreaterThanOrEqualTo(Slate.VERSION_THREE)){switch(r.ttl_cutoff_height=this.getTimeToLiveCutOffHeight()!==Slate.NO_TIME_TO_LIVE_CUT_OFF_HEIGHT?this.getTimeToLiveCutOffHeight().toFixed():Slate.NO_TIME_TO_LIVE_CUT_OFF_HEIGHT,Consensus.getWalletType()){case Consensus.MWC_WALLET_TYPE:r.payment_proof=!0===this.hasPaymentProof()?{receiver_address:this.getReceiverAddress(),receiver_signature:this.getReceiverSignature()!==Slate.NO_RECEIVER_SIGNATURE?Common.toHexString(this.getReceiverSignature()):null,sender_address:this.getSenderAddress()}:Slate.NO_PAYMENT_PROOF;break;case Consensus.GRIN_WALLET_TYPE:r.payment_proof=!0===this.hasPaymentProof()?{receiver_address:Common.toHexString(this.getReceiverAddress()),receiver_signature:this.getReceiverSignature()!==Slate.NO_RECEIVER_SIGNATURE?Common.toHexString(this.getReceiverSignature()):null,sender_address:Common.toHexString(this.getSenderAddress())}:Slate.NO_PAYMENT_PROOF}r.coin_type=Slate.COIN_TYPE,r.network_type=Slate.getNetworkType(e)}return r;default:throw"Unsupported slate version."}}getTransaction(){return{body:{inputs:this.getInputs().map((function(e){return e.getTransaction()})),kernels:this.getKernels().map((function(e){return e.getTransaction()})),outputs:this.getOutputs().map((function(e){return e.getTransaction()}))},offset:Common.toHexString(this.getOffset())}}getNumberOfParticipants(){return this.numberOfParticipants}getId(){return this.id}getOffset(){return this.offset}getInputs(){return this.inputs}getOutputs(){return this.outputs}getKernels(){return this.kernels}getAmount(){return this.amount}getFee(){return this.fee}getHeight(){return this.height}getLockHeight(){return this.lockHeight}getTimeToLiveCutOffHeight(){return this.timeToLiveCutOffHeight}getParticipants(){return this.participants}getVersion(){return this.version}getOriginalVersion(){return this.originalVersion}getBlockHeaderVersion(){return this.blockHeaderVersion}getReceiverAddress(){return this.receiverAddress}getReceiverSignature(){return this.receiverSignature}setReceiverSignature(e,t){return this.receiverSignature=e,!1!==this.verifyReceiverSignature(t)}getSenderAddress(){return this.senderAddress}getParticipant(e){for(var t=0;t<this.getParticipants().length;++t){var r=this.getParticipants()[t];if(!0===r.getId().isEqualTo(e))return r}return Slate.NO_PARTICIPANT}addOutputs(e){this.updateKernel();for(var t=0;t<e.length;++t){var r=e[t];this.outputs.push(r)}return!1!==this.sort()&&(!1!==this.verifyWeight()&&(!1!==this.verifySortedAndUnique()&&!1!==this.verifyNoCutThrough()))}addInputs(e){this.updateKernel();for(var t=0;t<e.length;++t){var r=e[t];this.inputs.push(r)}return!1!==this.sort()&&(!1!==this.verifyWeight()&&(!1!==this.verifySortedAndUnique()&&!1!==this.verifyNoCutThrough()))}generateOffset(e){var t=this;return new Promise((function(r,i){if(!1===Common.arraysAreEqual(t.getOffset(),Slate.ZERO_OFFSET))i("Offset isn't zero.");else{t.offset=new Uint8Array(Crypto.BLINDING_FACTOR_LENGTH);do{crypto.getRandomValues(t.offset)}while(!1===Secp256k1Zkp.isValidSecretKey(t.getOffset()));if(e instanceof Uint8Array!=!0)return e.applyOffsetToTransaction(t.getOffset()).then((function(){r()})).catch((function(e){i(e)}));var n=e;if(!1===Secp256k1Zkp.isValidSecretKey(n))i("Secret key isn't a valid secret key.");else{var s=Secp256k1Zkp.blindSum([n],[t.getOffset()]);s===Secp256k1Zkp.OPERATION_FAILED?i("Getting blind offset from secret key and offset failed."):!1===Common.arraysAreEqual(s,Crypto.ZERO_BLINDING_FACTOR)&&!1===Secp256k1Zkp.isValidSecretKey(s)?i("Blind offset isn't a valid secret key."):r(s)}}}))}addParticipant(e,t,r){var i=this;return new Promise((function(n,s){if(!0!==Common.arraysAreEqual(i.getOffset(),Slate.ZERO_OFFSET)){for(var a=SlateParticipant.SENDER_ID;i.getParticipant(a)!==Slate.NO_PARTICIPANT;)a=a.plus(1);return new Promise((function(t,r){if(e instanceof Uint8Array!=1)return e.getTransactionPublicKey().then((function(e){t(e)})).catch((function(e){r(e)}));var i=e,n=Secp256k1Zkp.publicKeyFromSecretKey(i);n===Secp256k1Zkp.OPERATION_FAILED?r("Getting public blind excess failed."):t(n)})).then((function(o){var u=Secp256k1Zkp.publicKeyFromSecretKey(t);if(u!==Secp256k1Zkp.OPERATION_FAILED){return new Promise((function(r,n){if(!0!==a.isEqualTo(SlateParticipant.SENDER_ID))return i.createPartialSignature(e,t,!0).then((function(e){r(e)})).catch((function(e){n(e)}));r(SlateParticipant.NO_PARTIAL_SIGNATURE)})).then((function(t){if(r!==SlateParticipant.NO_MESSAGE){var g=Blake2b.compute(Crypto.SINGLE_SIGNER_MESSAGE_LENGTH,(new TextEncoder).encode(r),new Uint8Array);if(g===Blake2b.OPERATION_FAILED)return void s("Getting message's hash failed.");if(e instanceof Uint8Array!=!0)return void s("Message signature can't be retrieved from a hardware wallet.");var l=e;if((c=Secp256k1Zkp.createSingleSignerSignature(g,l,Secp256k1Zkp.NO_SECRET_NONCE,o,Secp256k1Zkp.NO_PUBLIC_NONCE,Secp256k1Zkp.NO_PUBLIC_NONCE_TOTAL))===Secp256k1Zkp.OPERATION_FAILED)return void s("Creating message signature.")}else var c=SlateParticipant.NO_MESSAGE_SIGNATURE;try{var h=new SlateParticipant(a,o,u,t,r,c)}catch(e){return void s("Creating participant failed.")}i.participants.push(h),!1===i.verifyPartialSignatures()?s("Verifying partial signature failed."):n()})).catch((function(e){s(e)}))}s("Getting a public nonce failed.")})).catch((function(e){s(e)}))}s("Offset is zero.")}))}finalize(e,t,r,i){var n=this;return new Promise((function(s,a){return n.createPartialSignature(e,t,!1).then((function(e){if(n.getParticipant(SlateParticipant.SENDER_ID).setPartialSignature(e),!1===n.verifyPartialSignatures())a("Verifying partial signature failed.");else{for(var t=[],o=0;o<n.getParticipants().length;++o){var u=n.getParticipants()[o];if(!0!==u.isComplete())return void a("Participant isn't complete.");t.push(u.getPartialSignature())}var g=Secp256k1Zkp.combinePublicKeys(n.getParticipants().map((function(e){return e.getPublicNonce()})));if(g===Secp256k1Zkp.OPERATION_FAILED)a("Getting public nonce sum failed.");else{var l=Secp256k1Zkp.combinePublicKeys(n.getParticipants().map((function(e){return e.getPublicBlindExcess()})));if(l===Secp256k1Zkp.OPERATION_FAILED)a("Getting public blind excess sum failed.");else{var c=Secp256k1Zkp.addSingleSignerSignatures(t,g);if(c===Secp256k1Zkp.OPERATION_FAILED)a("Getting final signature failed.");else{try{var h=SlateKernel.signatureMessage(n.getKernelFeatures(),n.getFee(),n.getLockHeight())}catch(e){return void a("Getting message to sign failed.")}!1===Secp256k1Zkp.verifySingleSignerSignature(c,h,Secp256k1Zkp.NO_PUBLIC_NONCE,l,l,!0)?a("Verifying final signature failed."):1!==n.getKernels().length?a("Only one kernel doesn't exists."):(n.getKernels()[0].setExcess(n.getExcess()),!1===n.getKernels()[0].setExcessSignature(c)?a("Setting kernel's excess signature failed."):!1===n.sort()?a("Sorting failed."):!1===n.verifyWeight()||!1===n.verifySortedAndUnique()?a("Verifying weight failed."):!1===n.verifyFees(r)?a("Verifying fees failed."):!1===n.getKernels()[0].isComplete()?a("Kernel isn't complete."):!1===n.verifyKernelSums()?a("Verifying kernel sums failed."):!0===n.hasPaymentProof()&&n.getReceiverSignature()===Slate.NO_RECEIVER_SIGNATURE?a("Receiver signature doesn't exist."):!1===n.verifyReceiverSignature(i)?a("Verifying receiver signature failed."):s())}}}}})).catch((function(e){a("Creating partial signature failed.")}))}))}getOffsetExcess(){if(!1===Common.arraysAreEqual(this.getOffset(),Slate.ZERO_OFFSET)&&!1===Secp256k1Zkp.isValidSecretKey(this.getOffset()))throw"Offset isn't a valid secret key.";var e=Secp256k1Zkp.pedersenCommit(this.getOffset(),new BigNumber(0).toFixed());if(e===Secp256k1Zkp.OPERATION_FAILED)throw"Performing Pedersen commit with the offset and zero failed.";return e}getExcess(){try{var e=this.getOffsetExcess()}catch(e){throw e}var t=this.getCommitsSum();if(!1===t)throw"Getting transaction excess from commits sum failed.";var r=Secp256k1Zkp.pedersenCommitSum([t],[e]);if(r===Secp256k1Zkp.OPERATION_FAILED)throw"Getting excess from transaction excess and offset excess failed.";return r}isEqualTo(e){if(!1===Common.arraysAreEqual(this.getId().getData(),e.getId().getData()))return!1;if(!1===this.getAmount().isEqualTo(e.getAmount()))return!1;if(!1===this.getFee().isEqualTo(e.getFee()))return!1;if(!1===this.getLockHeight().isEqualTo(e.getLockHeight()))return!1;if(!1===this.getHeight().isEqualTo(e.getHeight()))return!1;if(this.getTimeToLiveCutOffHeight()===Slate.NO_TIME_TO_LIVE_CUT_OFF_HEIGHT&&e.getTimeToLiveCutOffHeight()!==Slate.NO_TIME_TO_LIVE_CUT_OFF_HEIGHT||this.getTimeToLiveCutOffHeight()!==Slate.NO_TIME_TO_LIVE_CUT_OFF_HEIGHT&&e.getTimeToLiveCutOffHeight()===Slate.NO_TIME_TO_LIVE_CUT_OFF_HEIGHT||this.getTimeToLiveCutOffHeight()!==Slate.NO_TIME_TO_LIVE_CUT_OFF_HEIGHT&&!1===this.getTimeToLiveCutOffHeight().isEqualTo(e.getTimeToLiveCutOffHeight()))return!1;if(!1===this.getNumberOfParticipants().isEqualTo(e.getNumberOfParticipants()))return!1;if(!1===Common.arraysAreEqual(this.getOffset(),e.getOffset()))return!1;if(!1===this.getBlockHeaderVersion().isEqualTo(e.getBlockHeaderVersion()))return!1;if(!1===this.getOriginalVersion().isEqualTo(e.getOriginalVersion()))return!1;if(!0===this.getVersion().isLessThan(e.getVersion()))return!1;switch(Consensus.getWalletType()){case Consensus.MWC_WALLET_TYPE:if(this.getReceiverAddress()!==e.getReceiverAddress())return!1;if(this.getSenderAddress()!==e.getSenderAddress())return!1;break;case Consensus.GRIN_WALLET_TYPE:if(this.getReceiverAddress()===Slate.NO_RECEIVER_ADDRESS&&e.getReceiverAddress()!==Slate.NO_RECEIVER_ADDRESS||this.getReceiverAddress()!==Slate.NO_RECEIVER_ADDRESS&&e.getReceiverAddress()===Slate.NO_RECEIVER_ADDRESS||this.getReceiverAddress()!==Slate.NO_RECEIVER_ADDRESS&&!1===Common.arraysAreEqual(this.getReceiverAddress(),e.getReceiverAddress()))return!1;if(this.getSenderAddress()===Slate.NO_SENDER_ADDRESS&&e.getSenderAddress()!==Slate.NO_SENDER_ADDRESS||this.getSenderAddress()!==Slate.NO_SENDER_ADDRESS&&e.getSenderAddress()===Slate.NO_SENDER_ADDRESS||this.getSenderAddress()!==Slate.NO_SENDER_ADDRESS&&!1===Common.arraysAreEqual(this.getSenderAddress(),e.getSenderAddress()))return!1}if(this.getInputs().length!==e.getInputs().length)return!1;for(var t=0;t<this.getInputs().length;++t)if(!1===this.getInputs()[t].isEqualTo(e.getInputs()[t]))return!1;if(this.getKernels().length!==e.getKernels().length)return!1;for(t=0;t<this.getKernels().length;++t)if(!1===this.getKernels()[t].isEqualTo(e.getKernels()[t]))return!1;for(t=0;t<this.getOutputs().length;++t){for(var r=!1,i=0;i<e.getOutputs().length;++i)if(!0===this.getOutputs()[t].isEqualTo(e.getOutputs()[i])){r=!0;break}if(!1===r)return!1}for(t=0;t<this.getParticipants().length;++t){var n=!1;for(i=0;i<e.getParticipants().length;++i)if(!0===this.getParticipants()[t].isEqualTo(e.getParticipants()[i])){n=!0;break}if(!1===n)return!1}return!0}static getPaymentProofMessage(e,t,r){switch(Consensus.getWalletType()){case Consensus.MWC_WALLET_TYPE:return(new TextEncoder).encode(Common.toHexString(t)+r+e.toFixed());case Consensus.GRIN_WALLET_TYPE:return Common.mergeArrays([new Uint8Array(e.toBytes(BigNumber.BIG_ENDIAN,Common.BYTES_IN_A_UINT64)),t,r])}}static get SUPPORTED_VERSIONS(){switch(Consensus.getWalletType()){case Consensus.MWC_WALLET_TYPE:return["V"+Slate.VERSION_TWO.toFixed(),"V"+Slate.VERSION_THREE.toFixed(),"V"+Slate.VERSION_THREE.toFixed()+"B"];case Consensus.GRIN_WALLET_TYPE:return["V"+Slate.VERSION_TWO.toFixed(),"V"+Slate.VERSION_THREE.toFixed()]}}static getRequiredFee(e,t,r,i){var n=new BigNumber(t).multipliedBy(Slate.BODY_WEIGHT_OUTPUT_FACTOR).plus(r).minus(e);return!0===n.isLessThan(Slate.MINIMUM_BODY_WEIGHT)&&(n=new BigNumber(Slate.MINIMUM_BODY_WEIGHT)),n.multipliedBy(i)}static get NO_TIME_TO_LIVE_CUT_OFF_HEIGHT(){return null}static get NO_PAYMENT_PROOF(){return null}static get NEWEST_VERSION(){return Slate.VERSION_THREE}reset(){this.version=Slate.NEWEST_VERSION,this.originalVersion=this.getVersion(),this.blockHeaderVersion=Consensus.LEGACY_HEADER_VERSION,this.numberOfParticipants=Slate.DEFAULT_NUMBER_OF_PARTICIPANTS,this.offset=Slate.ZERO_OFFSET,this.inputs=[],this.outputs=[],this.kernels=[],this.amount=new BigNumber(0),this.fee=new BigNumber(0),this.height=new BigNumber(Consensus.FIRST_BLOCK_HEIGHT),this.lockHeight=Slate.NO_LOCK_HEIGHT,this.timeToLiveCutOffHeight=Slate.NO_TIME_TO_LIVE_CUT_OFF_HEIGHT,this.participants=[],this.receiverAddress=Slate.NO_RECEIVER_ADDRESS,this.receiverSignature=Slate.NO_RECEIVER_SIGNATURE,this.senderAddress=Slate.NO_SENDER_ADDRESS,this.id=new Uuid(Uuid.randomSerializedUuid())}unserialize(e,t){switch(Slate.detectVersion(e,t).toFixed()){case Slate.VERSION_TWO.toFixed():case Slate.VERSION_THREE.toFixed():if("version_info"in e==!1||!1===Object.isObject(e.version_info))throw"Unsupported slate.";if("version"in e.version_info==!1||!1===Common.isNumberString(e.version_info.version)&&e.version_info.version instanceof BigNumber==!1||!1===new BigNumber(e.version_info.version).isInteger()||!0===new BigNumber(e.version_info.version).isLessThan(Slate.VERSION_ONE))throw"Unsupported slate.";if(this.version=new BigNumber(e.version_info.version),"num_participants"in e==!1||!1===Common.isNumberString(e.num_participants)&&e.num_participants instanceof BigNumber==!1||!1===new BigNumber(e.num_participants).isInteger()||!0===new BigNumber(e.num_participants).isLessThan(Slate.MINIMUM_NUMBER_OF_PARTICIPANTS))throw"Unsupported slate.";if(this.numberOfParticipants=new BigNumber(e.num_participants),"amount"in e==!1||!1===Common.isNumberString(e.amount)&&e.amount instanceof BigNumber==!1||!1===new BigNumber(e.amount).isInteger()||!0===new BigNumber(e.amount).isNegative())throw"Unsupported slate.";if(this.amount=new BigNumber(e.amount),"fee"in e==!1||!1===Common.isNumberString(e.fee)&&e.fee instanceof BigNumber==!1||!1===new BigNumber(e.fee).isInteger()||!0===new BigNumber(e.fee).isNegative())throw"Unsupported slate.";if(this.fee=new BigNumber(e.fee),"height"in e==!1||!1===Common.isNumberString(e.height)&&e.height instanceof BigNumber==!1||!1===new BigNumber(e.height).isInteger()||!0===new BigNumber(e.height).isLessThan(Consensus.FIRST_BLOCK_HEIGHT))throw"Unsupported slate.";if(this.height=new BigNumber(e.height),"lock_height"in e==!1||!1===Common.isNumberString(e.lock_height)&&e.lock_height instanceof BigNumber==!1||!1===new BigNumber(e.lock_height).isInteger()||!0===new BigNumber(e.lock_height).isLessThan(Slate.NO_LOCK_HEIGHT))throw"Unsupported slate.";if(this.lockHeight=new BigNumber(e.lock_height),"orig_version"in e.version_info==!1||!1===Common.isNumberString(e.version_info.orig_version)&&e.version_info.orig_version instanceof BigNumber==!1||!1===new BigNumber(e.version_info.orig_version).isInteger()||!0===new BigNumber(e.version_info.orig_version).isLessThan(Slate.VERSION_ONE))throw"Unsupported slate.";if(this.originalVersion=new BigNumber(e.version_info.orig_version),"block_header_version"in e.version_info==!1||!1===Common.isNumberString(e.version_info.block_header_version)&&e.version_info.block_header_version instanceof BigNumber==!1||!1===new BigNumber(e.version_info.block_header_version).isInteger()||!1===Consensus.isValidHeaderVersion(t,this.getHeight(),new BigNumber(e.version_info.block_header_version)))throw"Unsupported slate.";if(this.blockHeaderVersion=new BigNumber(e.version_info.block_header_version),!0===this.getVersion().isGreaterThanOrEqualTo(Slate.VERSION_THREE)){if("ttl_cutoff_height"in e==!1||null!==e.ttl_cutoff_height&&(!1===Common.isNumberString(e.ttl_cutoff_height)&&e.ttl_cutoff_height instanceof BigNumber==!1||!1===new BigNumber(e.ttl_cutoff_height).isInteger()||!0===new BigNumber(e.ttl_cutoff_height).isLessThanOrEqualTo(this.getHeight())))throw"Unsupported slate.";if(this.timeToLiveCutOffHeight=null!==e.ttl_cutoff_height?new BigNumber(e.ttl_cutoff_height):Slate.NO_TIME_TO_LIVE_CUT_OFF_HEIGHT,"payment_proof"in e==!1||null!==e.payment_proof&&!1===Object.isObject(e.payment_proof))throw"Unsupported slate.";switch(Consensus.getWalletType()){case Consensus.MWC_WALLET_TYPE:if(null!==e.payment_proof&&("receiver_address"in e.payment_proof==!1||"string"!=typeof e.payment_proof.receiver_address||e.payment_proof.receiver_address.length!==Mqs.ADDRESS_LENGTH&&e.payment_proof.receiver_address.length!==Tor.ADDRESS_LENGTH))throw"Unsupported slate.";if(null!==e.payment_proof){switch(e.payment_proof.receiver_address.length){case Mqs.ADDRESS_LENGTH:try{Mqs.mqsAddressToPublicKey(e.payment_proof.receiver_address,t)}catch(e){throw"Unsupported slate."}break;case Tor.ADDRESS_LENGTH:try{Tor.torAddressToPublicKey(e.payment_proof.receiver_address)}catch(e){throw"Unsupported slate."}}this.receiverAddress=e.payment_proof.receiver_address}else this.receiverAddress=Slate.NO_RECEIVER_ADDRESS;if(null!==e.payment_proof&&("receiver_signature"in e.payment_proof==!1||null!==e.payment_proof.receiver_signature&&(!1===Common.isHexString(e.payment_proof.receiver_signature)||Common.fromHexString(e.payment_proof.receiver_signature).length>Crypto.MAXIMUM_MESSAGE_HASH_SIGNATURE_LENGTH&&Common.fromHexString(e.payment_proof.receiver_signature).length!==Crypto.ED25519_SIGNATURE_LENGTH)))throw"Unsupported slate.";if(this.receiverSignature=null!==e.payment_proof&&null!==e.payment_proof.receiver_signature?Common.fromHexString(e.payment_proof.receiver_signature):Slate.NO_RECEIVER_SIGNATURE,null!==e.payment_proof&&("sender_address"in e.payment_proof==!1||"string"!=typeof e.payment_proof.sender_address||e.payment_proof.sender_address.length!==Mqs.ADDRESS_LENGTH&&e.payment_proof.sender_address.length!==Tor.ADDRESS_LENGTH))throw"Unsupported slate.";if(null!==e.payment_proof){switch(e.payment_proof.sender_address.length){case Mqs.ADDRESS_LENGTH:try{Mqs.mqsAddressToPublicKey(e.payment_proof.sender_address,t)}catch(e){throw"Unsupported slate."}break;case Tor.ADDRESS_LENGTH:try{Tor.torAddressToPublicKey(e.payment_proof.sender_address)}catch(e){throw"Unsupported slate."}}this.senderAddress=e.payment_proof.sender_address}else this.senderAddress=Slate.NO_SENDER_ADDRESS;break;case Consensus.GRIN_WALLET_TYPE:if(null!==e.payment_proof&&("receiver_address"in e.payment_proof==!1||!1===Common.isHexString(e.payment_proof.receiver_address)||Common.fromHexString(e.payment_proof.receiver_address).length!==Crypto.ED25519_PUBLIC_KEY_LENGTH))throw"Unsupported slate.";if(this.receiverAddress=null!==e.payment_proof?Common.fromHexString(e.payment_proof.receiver_address):Slate.NO_RECEIVER_ADDRESS,null!==e.payment_proof&&("receiver_signature"in e.payment_proof==!1||null!==e.payment_proof.receiver_signature&&(!1===Common.isHexString(e.payment_proof.receiver_signature)||Common.fromHexString(e.payment_proof.receiver_signature).length!==Crypto.ED25519_SIGNATURE_LENGTH)))throw"Unsupported slate.";if(this.receiverSignature=null!==e.payment_proof&&null!==e.payment_proof.receiver_signature?Common.fromHexString(e.payment_proof.receiver_signature):Slate.NO_RECEIVER_SIGNATURE,null!==e.payment_proof&&("sender_address"in e.payment_proof==!1||!1===Common.isHexString(e.payment_proof.sender_address)||Common.fromHexString(e.payment_proof.sender_address).length!==Crypto.ED25519_PUBLIC_KEY_LENGTH))throw"Unsupported slate.";this.senderAddress=null!==e.payment_proof?Common.fromHexString(e.payment_proof.sender_address):Slate.NO_SENDER_ADDRESS}}if("id"in e==!1||"string"!=typeof e.id)throw"Unsupported slate.";try{if(this.id=new Uuid(e.id),!1===this.getId().isRandom())throw"Unsupported slate."}catch(e){throw"Unsupported slate."}if("tx"in e==!1||!1===Object.isObject(e.tx))throw"Unsupported slate.";if("body"in e.tx==!1||!1===Object.isObject(e.tx.body))throw"Unsupported slate.";if("inputs"in e.tx.body==!1||!1===Array.isArray(e.tx.body.inputs))throw"Unsupported slate.";try{var r=this;this.inputs=e.tx.body.inputs.map((function(e){return new SlateInput(e,r)}))}catch(e){throw"Unsupported slate."}if(0===this.getInputs().length)throw"Unsupported slate.";if("outputs"in e.tx.body==!1||!1===Array.isArray(e.tx.body.outputs))throw"Unsupported slate.";try{this.outputs=e.tx.body.outputs.map((function(e){return new SlateOutput(e,r)}))}catch(e){throw"Unsupported slate."}if("kernels"in e.tx.body==!1||!1===Array.isArray(e.tx.body.kernels))throw"Unsupported slate.";try{this.kernels=e.tx.body.kernels.map((function(e){return new SlateKernel(e,r,t)}))}catch(e){throw"Unsupported slate."}if(0===this.getKernels().length)throw"Unsupported slate.";if("offset"in e.tx==!1||!1===Common.isHexString(e.tx.offset)||Common.fromHexString(e.tx.offset).length!==Crypto.BLINDING_FACTOR_LENGTH||!0===Common.arraysAreEqual(Common.fromHexString(e.tx.offset),Slate.ZERO_OFFSET))throw"Unsupported slate.";if(this.offset=Common.fromHexString(e.tx.offset),"participant_data"in e==!1||!1===Array.isArray(e.participant_data)||!0===this.getNumberOfParticipants().isLessThan(e.participant_data.length))throw"Unsupported slate.";try{this.participants=e.participant_data.map((function(e){return new SlateParticipant(e,r)}))}catch(e){throw"Unsupported slate."}for(var i=[],n=!1,s=0;s<this.getParticipants().length;++s){var a=this.getParticipants()[s];if(i.indexOf(a.getId().toFixed())!==Common.INDEX_NOT_FOUND)throw"Unsupported slate.";i.push(a.getId().toFixed()),!0===a.isSender()&&(n=!0)}if(!1===n)throw"Unsupported slate.";if(!1===this.verifyPartialSignatures())throw"Unsupported slate.";if(!1===this.verifyReceiverSignature(t))throw"Unsupported slate.";if(!1===this.verifyWeight())throw"Unsupported slate.";if(!1===this.verifyNoRecentDuplicateKernels(t))throw"Unsupported slate.";if(!1===this.verifySortedAndUnique())throw"Unsupported slate.";if(!1===this.verifyNoCutThrough())throw"Unsupported slate.";if(!0===this.getKernels()[0].isComplete()&&!1===this.verifyKernelSums())throw"Unsupported slate.";break;default:throw"Unsupported slate."}}minimumCompatibleVersion(e){return this.getTimeToLiveCutOffHeight()!==Slate.NO_TIME_TO_LIVE_CUT_OFF_HEIGHT||!0===this.hasPaymentProof()||e.indexOf("V"+Slate.VERSION_TWO.toFixed())===Common.INDEX_NOT_FOUND?Slate.VERSION_THREE:Slate.VERSION_TWO}verifyPartialSignatures(){try{var e=SlateKernel.signatureMessage(this.getKernelFeatures(),this.getFee(),this.getLockHeight())}catch(e){return!1}var t=Secp256k1Zkp.combinePublicKeys(this.getParticipants().map((function(e){return e.getPublicNonce()})));if(t===Secp256k1Zkp.OPERATION_FAILED)return!1;var r=Secp256k1Zkp.combinePublicKeys(this.getParticipants().map((function(e){return e.getPublicBlindExcess()})));if(r===Secp256k1Zkp.OPERATION_FAILED)return!1;for(var i=0;i<this.getParticipants().length;++i){var n=this.getParticipants()[i];if(!0===n.isComplete()&&!1===Secp256k1Zkp.verifySingleSignerSignature(n.getPartialSignature(),e,t,n.getPublicBlindExcess(),r,!0))return!1}return!0}verifyReceiverSignature(e){if(this.getReceiverSignature()!==Slate.NO_RECEIVER_SIGNATURE){try{var t=this.getExcess()}catch(e){return!1}try{var r=Slate.getPaymentProofMessage(this.getAmount(),t,this.getSenderAddress());switch(Consensus.getWalletType()){case Consensus.MWC_WALLET_TYPE:switch(this.getReceiverAddress().length){case Mqs.ADDRESS_LENGTH:var i=new Uint8Array(sha256.arrayBuffer(r)),n=Mqs.mqsAddressToPublicKey(this.getReceiverAddress(),e);if(!1===Secp256k1Zkp.verifyMessageHashSignature(this.getReceiverSignature(),i,n))return!1;break;case Tor.ADDRESS_LENGTH:n=Tor.torAddressToPublicKey(this.getReceiverAddress());if(!1===Ed25519.verify(r,this.getReceiverSignature(),n))return!1}break;case Consensus.GRIN_WALLET_TYPE:if(!1===Ed25519.verify(r,this.getReceiverSignature(),this.getReceiverAddress()))return!1}}catch(e){return!1}}return!0}verifyWeight(){var e=Consensus.BLOCK_OUTPUT_WEIGHT+Consensus.BLOCK_KERNEL_WEIGHT,t=Math.max(Consensus.MAXIMUM_BLOCK_WEIGHT-e,0);return!0!==this.getWeight().isGreaterThan(t)}getWeight(){var e=new BigNumber(this.getInputs().length).multipliedBy(Consensus.BLOCK_INPUT_WEIGHT),t=new BigNumber(this.getOutputs().length).multipliedBy(Consensus.BLOCK_OUTPUT_WEIGHT),r=new BigNumber(this.getKernels().length).multipliedBy(Consensus.BLOCK_KERNEL_WEIGHT);return e.plus(t).plus(r)}verifyNoRecentDuplicateKernels(e){if(!0===Consensus.isNoRecentDuplicateKernelsEnabled(e))for(var t=[],r=0;r<this.getKernels().length;++r){var i=this.getKernels()[r];if(!0===i.isNoRecentDuplicate()){if(t.indexOf(Common.toHexString(i.getExcess))!==Common.INDEX_NOT_FOUND)return!1;t.push(Common.toHexString(i.getExcess()))}}return!0}verifySortedAndUnique(){if(!1===Slate.isSortedAndUnique(this.getInputs().map((function(e){return e.getHash()}))))return!1;if(!1===Slate.isSortedAndUnique(this.getOutputs().map((function(e){return e.getHash()}))))return!1;try{if(!1===Slate.isSortedAndUnique(this.getKernels().map((function(e){return e.getHash()}))))return!1}catch(e){return!1}return!0}verifyNoCutThrough(){for(var e=[],t=0;t<this.getInputs().length;++t){var r=this.getInputs()[t].getHash().serialize();if(e.indexOf(r)!==Common.INDEX_NOT_FOUND)return!1;e.push(r)}for(t=0;t<this.getOutputs().length;++t){r=this.getOutputs()[t].getHash().serialize();if(e.indexOf(r)!==Common.INDEX_NOT_FOUND)return!1;e.push(r)}return!0}verifyFees(e){var t=Slate.getRequiredFee(this.getInputs().length,this.getOutputs().length,this.getKernels().length,e);return!0!==t.isGreaterThan(this.getOverage())&&!0!==t.isGreaterThan(this.getAmount().plus(this.getFee()))}verifyKernelSums(){for(var e=this.getKernels().map((function(e){return e.getExcess()})),t=0;t<e.length;++t){var r=e[t];!0===Common.arraysAreEqual(r,Slate.ZERO_COMMIT)&&e.splice(t--,1)}var i=Secp256k1Zkp.pedersenCommitSum(e,[]);if(i===Secp256k1Zkp.OPERATION_FAILED)return!1;var n=[i];if(!1===Common.arraysAreEqual(this.getOffset(),Slate.ZERO_OFFSET)){if(!1===Secp256k1Zkp.isValidSecretKey(this.getOffset()))return!1;var s=Secp256k1Zkp.pedersenCommit(this.getOffset(),new BigNumber(0).toFixed());if(s===Secp256k1Zkp.OPERATION_FAILED)return!1;n.push(s)}var a=Secp256k1Zkp.pedersenCommitSum(n,[]);if(a===Secp256k1Zkp.OPERATION_FAILED)return!1;var o=this.getCommitsSum();return!1!==o&&!1!==Common.arraysAreEqual(o,a)}getKernelFeatures(){return!0===this.getLockHeight().isEqualTo(Slate.NO_LOCK_HEIGHT)?SlateKernel.PLAIN_FEATURES:SlateKernel.HEIGHT_LOCKED_FEATURES}getOverage(){for(var e=new BigNumber(0),t=0;t<this.getKernels().length;++t){var r=this.getKernels()[t];switch(r.getFeatures()){case SlateKernel.PLAIN_FEATURES:case SlateKernel.HEIGHT_LOCKED_FEATURES:case SlateKernel.NO_RECENT_DUPLICATE_FEATURES:e=e.plus(r.getFee())}}return e}getCommitsSum(){var e=this.getInputs().map((function(e){return e.getCommit()})),t=this.getOutputs().map((function(e){return e.getCommit()})),r=this.getOverage();if(!1===r.isZero()){try{var i=Crypto.commitAmount(r.absoluteValue())}catch(e){return!1}!0===r.isNegative()?e.push(i):t.push(i)}for(var n=0;n<e.length;++n){var s=e[n];!0===Common.arraysAreEqual(s,Slate.ZERO_COMMIT)&&e.splice(n--,1)}for(n=0;n<t.length;++n){var a=t[n];!0===Common.arraysAreEqual(a,Slate.ZERO_COMMIT)&&t.splice(n--,1)}var o=Secp256k1Zkp.pedersenCommitSum(t,e);return o!==Secp256k1Zkp.OPERATION_FAILED&&o}updateKernel(){switch(this.kernels=[],this.getKernelFeatures()){case SlateKernel.PLAIN_FEATURES:var e=this.getFee(),t=Slate.NO_LOCK_HEIGHT;break;case SlateKernel.HEIGHT_LOCKED_FEATURES:e=this.getFee(),t=this.getLockHeight()}var r=new SlateKernel(this.getKernelFeatures(),e,t,SlateKernel.NO_RELATIVE_HEIGHT,SlateKernel.ZERO_EXCESS,SlateKernel.ZERO_EXCESS_SIGNATURE);this.kernels.push(r)}sort(){this.inputs.sort((function(e,t){return e.getHash().compare(t.getHash())})),this.outputs.sort((function(e,t){return e.getHash().compare(t.getHash())}));try{this.kernels.sort((function(e,t){return e.getHash().compare(t.getHash())}))}catch(e){return!1}return!0}hasPaymentProof(){return this.getReceiverAddress()!==Slate.NO_RECEIVER_ADDRESS&&this.getSenderAddress()!==Slate.NO_SENDER_ADDRESS}createPartialSignature(e,t,r){var i=this;return new Promise((function(n,s){return new Promise((function(t,r){if(e instanceof Uint8Array!=1)return e.getTransactionPublicKey().then((function(e){t(e)})).catch((function(e){r(e)}));var i=e,n=Secp256k1Zkp.publicKeyFromSecretKey(i);n===Secp256k1Zkp.OPERATION_FAILED?r("Getting public blind excess failed."):t(n)})).then((function(a){var o=Secp256k1Zkp.publicKeyFromSecretKey(t);if(o===Secp256k1Zkp.OPERATION_FAILED)s("Getting a public nonce from secret nonce failed.");else{try{var u=SlateKernel.signatureMessage(i.getKernelFeatures(),i.getFee(),i.getLockHeight())}catch(e){return void s("Getting message to sign failed.")}var g=i.getParticipants().map((function(e){return e.getPublicNonce()}));!0===r&&g.push(o);var l=Secp256k1Zkp.combinePublicKeys(g);if(l===Secp256k1Zkp.OPERATION_FAILED)s("Getting public nonce sum failed.");else{var c=i.getParticipants().map((function(e){return e.getPublicBlindExcess()}));!0===r&&c.push(a);var h=Secp256k1Zkp.combinePublicKeys(c);if(h!==Secp256k1Zkp.OPERATION_FAILED){return new Promise((function(n,s){if(e instanceof Uint8Array!=1){var a=e;if(!1===r){try{var o=i.getExcess()}catch(e){return void s(e)}return a.getTransactionSignature(t,l,h,i.getKernelFeatures(),i.getLockHeight(),SlateKernel.NO_RELATIVE_HEIGHT,o,i.getSenderAddress(),i.getReceiverSignature()).then((function(e){n(e)})).catch((function(e){s(e)}))}return a.getTransactionSignature(t,l,h,i.getKernelFeatures(),i.getLockHeight()).then((function(e){n(e)})).catch((function(e){s(e)}))}var g=e,c=Secp256k1Zkp.createSingleSignerSignature(u,g,t,h,l,l);c===Secp256k1Zkp.OPERATION_FAILED?s("Creating partial signature failed."):n(c)})).then((function(e){n(e)})).catch((function(e){s(e)}))}s("Getting public blind excess sum failed.")}}})).catch((function(e){s(e)}))}))}static detectVersion(e,t){return"coin_type"in e==!0&&e.coin_type!==Slate.COIN_TYPE||"network_type"in e==!0&&e.network_type!==Slate.getNetworkType(t)?Slate.UNKNOWN_VERSION:"version_info"in e!=!0||!0!==Object.isObject(e.version_info)||"version"in e.version_info!=!0||!0!==Common.isNumberString(e.version_info.version)&&e.version_info.version instanceof BigNumber!=!0||!0!==new BigNumber(e.version_info.version).isInteger()?"version"in e!=!0||!0!==Common.isNumberString(e.version)&&e.version instanceof BigNumber!=!0||!0!==new BigNumber(e.version).isInteger()?Slate.UNKNOWN_VERSION:Slate.VERSION_ONE():new BigNumber(e.version_info.version)}static isSortedAndUnique(e){for(var t=1;t<e.length;++t){var r=e[t-1],i=e[t].compare(r);if(i===Hash.LESS_THAN||i===Hash.EQUAL_TO)return!1}return!0}static getNetworkType(e){return!0===e?"mainnet":"floonet"}static get VERSION_ONE(){return new BigNumber(1)}static get VERSION_TWO(){return new BigNumber(2)}static get VERSION_THREE(){return new BigNumber(3)}static get UNKNOWN_VERSION(){return new BigNumber(0)}static get NO_LOCK_HEIGHT(){return new BigNumber(0)}static get MINIMUM_NUMBER_OF_PARTICIPANTS(){return 2}static get ZERO_OFFSET(){return Crypto.ZERO_BLINDING_FACTOR}static get NO_PARTICIPANT(){return null}static get NO_RECEIVER_ADDRESS(){return null}static get NO_RECEIVER_SIGNATURE(){return null}static get NO_SENDER_ADDRESS(){return null}static get ZERO_COMMIT(){return new Uint8Array(Crypto.COMMIT_LENGTH).fill(0)}static get BODY_WEIGHT_OUTPUT_FACTOR(){return 4}static get MINIMUM_BODY_WEIGHT(){return 1}static get DEFAULT_NUMBER_OF_PARTICIPANTS(){return new BigNumber(2)}static get COIN_TYPE(){switch(Consensus.getWalletType()){case Consensus.MWC_WALLET_TYPE:return"mwc"}}}