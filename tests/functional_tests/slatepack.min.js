"use strict";const crypto=require("crypto"),X25519=require("./X25519.min.js"),bech32=require("./bech32-2.0.0.min.js"),chacha=require("./ChaCha-2.1.0.min.js"),Common=require("./common.min.js"),Crypto=require("./crypto.min.js"),Consensus=require("./consensus.min.js");class Slatepack{static publicKeyToSlatepackAddress(e){return bech32.encode(Consensus.SLATEPACK_ADDRESS_HUMAN_READABLE_PART,bech32.toWords(e))}static slatepackAddressToPublicKey(e){try{var E=bech32.decode(e)}catch(e){throw"Invalid Slatepack address."}var t=bech32.fromWords(E.words);if(t.length!==Crypto.ED25519_PUBLIC_KEY_LENGTH)throw"Invalid Slatepack address.";if(E.prefix!==Consensus.SLATEPACK_ADDRESS_HUMAN_READABLE_PART)throw"Invalid Slatepack address.";return new Uint8Array(t)}static isEncryptedSlatepack(e){var E=e.indexOf(Slatepack.COMPONENT_SEPARATOR);return E!==Common.INDEX_NOT_FOUND&&!0===Slatepack.ENCRYPTED_HEADER_PATTERN.test(e.substring(0,E))}static getSlatepackSenderPublicKey(e){var E=e.indexOf(Slatepack.COMPONENT_SEPARATOR);if(E===Common.INDEX_NOT_FOUND)return Slatepack.NO_PUBLIC_KEY;if(!1===Slatepack.ENCRYPTED_HEADER_PATTERN.test(e.substring(0,E)))return Slatepack.NO_PUBLIC_KEY;var t=e.indexOf(Slatepack.COMPONENT_SEPARATOR,E+Slatepack.COMPONENT_SEPARATOR.length);if(t===Common.INDEX_NOT_FOUND)return Slatepack.NO_PUBLIC_KEY;var r=e.indexOf(Slatepack.COMPONENT_SEPARATOR,t+Slatepack.COMPONENT_SEPARATOR.length);if(r===Common.INDEX_NOT_FOUND)return Slatepack.NO_PUBLIC_KEY;if(!1===Slatepack.ENCRYPTED_FOOTER_PATTERN.test(e.substring(t+Slatepack.COMPONENT_SEPARATOR.length,r)))return Slatepack.NO_PUBLIC_KEY;var a=e.substring(E+Slatepack.COMPONENT_SEPARATOR.length,t).replace(Slatepack.WHITESPACE_PATTERN,"");try{var _=Base58.decode(a)}catch(e){return Slatepack.NO_PUBLIC_KEY}if(_.length<Base58.CHECKSUM_LENGTH+Uint8Array.BYTES_PER_ELEMENT)return Slatepack.NO_PUBLIC_KEY;var n=_.subarray(0,Base58.CHECKSUM_LENGTH),N=_.subarray(Base58.CHECKSUM_LENGTH);if(!1===Common.arraysAreEqual(n,Base58.getChecksum(N)))return Slatepack.NO_PUBLIC_KEY;if(N[0]>Slatepack.VERSION)return Slatepack.NO_PUBLIC_KEY;if(N.length<N.BYTES_PER_ELEMENT+Crypto.ED25519_PUBLIC_KEY_LENGTH+Crypto.ED25519_PUBLIC_KEY_LENGTH+Slatepack.NONCE_LENGTH+Uint16Array.BYTES_PER_ELEMENT)return Slatepack.NO_PUBLIC_KEY;var T=N.subarray(N.BYTES_PER_ELEMENT,N.BYTES_PER_ELEMENT+Crypto.ED25519_PUBLIC_KEY_LENGTH);try{Tor.publicKeyToTorAddress(T)}catch(e){return Slatepack.NO_PUBLIC_KEY}return T}static getSlatepackReceiverPublicKey(e){var E=e.indexOf(Slatepack.COMPONENT_SEPARATOR);if(E===Common.INDEX_NOT_FOUND)return Slatepack.NO_PUBLIC_KEY;if(!1===Slatepack.ENCRYPTED_HEADER_PATTERN.test(e.substring(0,E)))return Slatepack.NO_PUBLIC_KEY;var t=e.indexOf(Slatepack.COMPONENT_SEPARATOR,E+Slatepack.COMPONENT_SEPARATOR.length);if(t===Common.INDEX_NOT_FOUND)return Slatepack.NO_PUBLIC_KEY;var r=e.indexOf(Slatepack.COMPONENT_SEPARATOR,t+Slatepack.COMPONENT_SEPARATOR.length);if(r===Common.INDEX_NOT_FOUND)return Slatepack.NO_PUBLIC_KEY;if(!1===Slatepack.ENCRYPTED_FOOTER_PATTERN.test(e.substring(t+Slatepack.COMPONENT_SEPARATOR.length,r)))return Slatepack.NO_PUBLIC_KEY;var a=e.substring(E+Slatepack.COMPONENT_SEPARATOR.length,t).replace(Slatepack.WHITESPACE_PATTERN,"");try{var _=Base58.decode(a)}catch(e){return Slatepack.NO_PUBLIC_KEY}if(_.length<Base58.CHECKSUM_LENGTH+Uint8Array.BYTES_PER_ELEMENT)return Slatepack.NO_PUBLIC_KEY;var n=_.subarray(0,Base58.CHECKSUM_LENGTH),N=_.subarray(Base58.CHECKSUM_LENGTH);if(!1===Common.arraysAreEqual(n,Base58.getChecksum(N)))return Slatepack.NO_PUBLIC_KEY;if(N[0]>Slatepack.VERSION)return Slatepack.NO_PUBLIC_KEY;if(N.length<N.BYTES_PER_ELEMENT+Crypto.ED25519_PUBLIC_KEY_LENGTH+Crypto.ED25519_PUBLIC_KEY_LENGTH+Slatepack.NONCE_LENGTH+Uint16Array.BYTES_PER_ELEMENT)return Slatepack.NO_PUBLIC_KEY;var T=N.subarray(N.BYTES_PER_ELEMENT+Crypto.ED25519_PUBLIC_KEY_LENGTH,N.BYTES_PER_ELEMENT+Crypto.ED25519_PUBLIC_KEY_LENGTH+Crypto.ED25519_PUBLIC_KEY_LENGTH);try{Tor.publicKeyToTorAddress(T)}catch(e){return Slatepack.NO_PUBLIC_KEY}return T}static decodeSlatepack(e,E=Slatepack.NO_SECRET_KEY,t=HardwareWallet.NO_TEXT,r=[],a=!1,_=!1,n=Common.NO_CANCEL_OCCURED){return new Promise((function(N,T){var c=e.indexOf(Slatepack.COMPONENT_SEPARATOR);if(c!==Common.INDEX_NOT_FOUND){if(!1===Slatepack.ENCRYPTED_HEADER_PATTERN.test(e.substring(0,c))){if(!1===Slatepack.BINARY_HEADER_PATTERN.test(e.substring(0,c)))return void T("Unsupported slatepack.");var l=!1}else l=!0;var i=e.indexOf(Slatepack.COMPONENT_SEPARATOR,c+Slatepack.COMPONENT_SEPARATOR.length);if(i!==Common.INDEX_NOT_FOUND){var A=e.indexOf(Slatepack.COMPONENT_SEPARATOR,i+Slatepack.COMPONENT_SEPARATOR.length);if(A!==Common.INDEX_NOT_FOUND)if(!0!==l||!1!==Slatepack.ENCRYPTED_FOOTER_PATTERN.test(e.substring(i+Slatepack.COMPONENT_SEPARATOR.length,A)))if(!1!==l||!1!==Slatepack.BINARY_FOOTER_PATTERN.test(e.substring(i+Slatepack.COMPONENT_SEPARATOR.length,A))){var s=e.substring(c+Slatepack.COMPONENT_SEPARATOR.length,i).replace(Slatepack.WHITESPACE_PATTERN,"");try{var S=Base58.decode(s)}catch(e){return void T("Unsupported slatepack.")}if(S.length<Base58.CHECKSUM_LENGTH+Uint8Array.BYTES_PER_ELEMENT)T("Unsupported slatepack.");else{var o=S.subarray(0,Base58.CHECKSUM_LENGTH),C=S.subarray(Base58.CHECKSUM_LENGTH);if(!1!==Common.arraysAreEqual(o,Base58.getChecksum(C))){var P=C[0];if(P>Slatepack.VERSION)T("Unsupported slatepack.");else{if(!0===l){if(E===Slatepack.NO_SECRET_KEY)return void T("Decrypting Slatepack failed.");if(C.length<C.BYTES_PER_ELEMENT+Crypto.ED25519_PUBLIC_KEY_LENGTH+Crypto.ED25519_PUBLIC_KEY_LENGTH+Slatepack.NONCE_LENGTH+Uint16Array.BYTES_PER_ELEMENT)return void T("Unsupported slatepack.");var p=C.subarray(C.BYTES_PER_ELEMENT,C.BYTES_PER_ELEMENT+Crypto.ED25519_PUBLIC_KEY_LENGTH);try{Tor.publicKeyToTorAddress(p)}catch(e){return void T("Invalid sender public key.")}var R=C.subarray(C.BYTES_PER_ELEMENT+Crypto.ED25519_PUBLIC_KEY_LENGTH,C.BYTES_PER_ELEMENT+Crypto.ED25519_PUBLIC_KEY_LENGTH+Crypto.ED25519_PUBLIC_KEY_LENGTH);try{Tor.publicKeyToTorAddress(R)}catch(e){return void T("Invalid receiver public key.")}return new Promise((function(e,N){if(E instanceof Uint8Array!=1)return E.getTorAddress(Wallet.PAYMENT_PROOF_TOR_ADDRESS_KEY_INDEX,t,r,a,_,n).then((function(E){try{var t=Tor.torAddressToPublicKey(E)}catch(e){return void N(e)}e(t)})).catch((function(e){N(e)}));var T=E,c=Ed25519.publicKeyFromSecretKey(T);c!==Ed25519.OPERATION_FAILED?e(c):N("Getting expected receiver public key from secret key failed.")})).then((function(e){if(!1!==Common.arraysAreEqual(R,e)){var c=C.subarray(C.BYTES_PER_ELEMENT+Crypto.ED25519_PUBLIC_KEY_LENGTH+Crypto.ED25519_PUBLIC_KEY_LENGTH,C.BYTES_PER_ELEMENT+Crypto.ED25519_PUBLIC_KEY_LENGTH+Crypto.ED25519_PUBLIC_KEY_LENGTH+Slatepack.NONCE_LENGTH),l=new BigNumber(Common.HEX_PREFIX+Common.toHexString(C.subarray(C.BYTES_PER_ELEMENT+Crypto.ED25519_PUBLIC_KEY_LENGTH+Crypto.ED25519_PUBLIC_KEY_LENGTH+Slatepack.NONCE_LENGTH,C.BYTES_PER_ELEMENT+Crypto.ED25519_PUBLIC_KEY_LENGTH+Crypto.ED25519_PUBLIC_KEY_LENGTH+Slatepack.NONCE_LENGTH+Uint16Array.BYTES_PER_ELEMENT))).toNumber();if(0===l||l!==C.length-(C.BYTES_PER_ELEMENT+Crypto.ED25519_PUBLIC_KEY_LENGTH+Crypto.ED25519_PUBLIC_KEY_LENGTH+Slatepack.NONCE_LENGTH+Uint16Array.BYTES_PER_ELEMENT))return void T("Unsupported slatepack.");var i=C.subarray(C.BYTES_PER_ELEMENT+Crypto.ED25519_PUBLIC_KEY_LENGTH+Crypto.ED25519_PUBLIC_KEY_LENGTH+Slatepack.NONCE_LENGTH+Uint16Array.BYTES_PER_ELEMENT);if(E instanceof Uint8Array==!0){var A=E;return Slatepack.decrypt(A,p,i,c).then((function(e){if(e.length<=Uint32Array.BYTES_PER_ELEMENT)T("Unsupported slatepack.");else{var E=new BigNumber(Common.HEX_PREFIX+Common.toHexString(e.subarray(e.length-Uint32Array.BYTES_PER_ELEMENT))).toNumber();e=e.subarray(0,e.length-Uint32Array.BYTES_PER_ELEMENT);var t=CRC32.buf(Common.mergeArrays([new Uint8Array([P]),p,R,e]));new Uint32Array([t])[0]===E?N(e):T("Unsupported slatepack.")}})).catch((function(e){T(e)}))}return E.decryptSlate(Wallet.PAYMENT_PROOF_TOR_ADDRESS_KEY_INDEX,i,Tor.publicKeyToTorAddress(p),c,HardwareWallet.NO_SALT,t,r,a,_,n).then((function(e){if(e.length<=Uint32Array.BYTES_PER_ELEMENT)T("Unsupported slatepack.");else{var E=new BigNumber(Common.HEX_PREFIX+Common.toHexString(e.subarray(e.length-Uint32Array.BYTES_PER_ELEMENT))).toNumber();e=e.subarray(0,e.length-Uint32Array.BYTES_PER_ELEMENT);var t=CRC32.buf(Common.mergeArrays([new Uint8Array([P]),p,R,e]));new Uint32Array([t])[0]===E?N(e):T("Unsupported slatepack.")}})).catch((function(e){T(e)}))}T("Invalid receiver public key.")})).catch((function(e){T(e)}))}if(C.length<C.BYTES_PER_ELEMENT+Uint16Array.BYTES_PER_ELEMENT)T("Unsupported slatepack.");else{var O=new BigNumber(Common.HEX_PREFIX+Common.toHexString(C.subarray(C.BYTES_PER_ELEMENT,C.BYTES_PER_ELEMENT+Uint16Array.BYTES_PER_ELEMENT))).toNumber();if(0!==O&&O===C.length-(C.BYTES_PER_ELEMENT+Uint16Array.BYTES_PER_ELEMENT)){var u=C.subarray(C.BYTES_PER_ELEMENT+Uint16Array.BYTES_PER_ELEMENT);N(u)}else T("Unsupported slatepack.")}}}else T("Unsupported slatepack.")}}else T("Unsupported slatepack.");else T("Unsupported slatepack.");else T("Unsupported slatepack.")}else T("Unsupported slate.")}else T("Unsupported slatepack.")}))}static encodeSlatepack(e,E=Slatepack.NO_SECRET_KEY,t=Slatepack.NO_PUBLIC_KEY,r=HardwareWallet.NO_TEXT,a=[],_=!1,n=!1,N=Common.NO_CANCEL_OCCURED){return new Promise((function(T,c){if(E!==Slatepack.NO_SECRET_KEY&&t!==Slatepack.NO_PUBLIC_KEY){return new Promise((function(e,t){if(E instanceof Uint8Array!=1)return E.getTorAddress(Wallet.PAYMENT_PROOF_TOR_ADDRESS_KEY_INDEX,r,a,_,n,N).then((function(E){try{var r=Tor.torAddressToPublicKey(E)}catch(e){return void t(e)}e(r)})).catch((function(e){t(e)}));var T=E,c=Ed25519.publicKeyFromSecretKey(T);c!==Ed25519.OPERATION_FAILED?e(c):t("Getting sender public key from secret key failed.")})).then((function(l){var i=CRC32.buf(Common.mergeArrays([new Uint8Array([Slatepack.VERSION]),l,t,e]));if(E instanceof Uint8Array==!0){var A=E;return Slatepack.encrypt(A,t,Common.mergeArrays([e,new BigNumber(new Uint32Array([i])[0]).toBytes(BigNumber.BIG_ENDIAN,Uint32Array.BYTES_PER_ELEMENT)])).then((function(e){if(e[Slatepack.ENCRYPTED_DATA_DATA_INDEX].length>Common.UINT16_MAX_VALUE)c("Encrypted slate is too long.");else{var E=Common.mergeArrays([new Uint8Array([Slatepack.VERSION]),l,t,e[Slatepack.ENCRYPTED_DATA_NONCE_INDEX],new BigNumber(e[Slatepack.ENCRYPTED_DATA_DATA_INDEX].length).toBytes(BigNumber.BIG_ENDIAN,Uint16Array.BYTES_PER_ELEMENT),e[Slatepack.ENCRYPTED_DATA_DATA_INDEX]]),r=Base58.encode(Common.mergeArrays([Base58.getChecksum(E),E]));r=Slatepack.format(r),r=Slatepack.ENCRYPTED_HEADER+r+Slatepack.ENCRYPTED_FOOTER,T(r)}})).catch((function(e){c(e)}))}return E.encryptSlate(Wallet.PAYMENT_PROOF_TOR_ADDRESS_KEY_INDEX,Common.mergeArrays([e,new BigNumber(new Uint32Array([i])[0]).toBytes(BigNumber.BIG_ENDIAN,Uint32Array.BYTES_PER_ELEMENT)]),Tor.publicKeyToTorAddress(t),r,a,_,n,N).then((function(e){if(e[HardwareWallet.ENCRYPTED_SLATE_DATA_INDEX].length>Common.UINT16_MAX_VALUE)c("Encrypted slate is too long.");else{var E=Common.mergeArrays([new Uint8Array([Slatepack.VERSION]),l,t,e[HardwareWallet.ENCRYPTED_SLATE_NONCE_INDEX],new BigNumber(e[HardwareWallet.ENCRYPTED_SLATE_DATA_INDEX].length).toBytes(BigNumber.BIG_ENDIAN,Uint16Array.BYTES_PER_ELEMENT),e[HardwareWallet.ENCRYPTED_SLATE_DATA_INDEX]]),r=Base58.encode(Common.mergeArrays([Base58.getChecksum(E),E]));r=Slatepack.format(r),r=Slatepack.ENCRYPTED_HEADER+r+Slatepack.ENCRYPTED_FOOTER,T(r)}})).catch((function(e){c(e)}))})).catch((function(e){c(e)}))}e.length>Common.UINT16_MAX_VALUE&&c("Slate is too long.");var l=Common.mergeArrays([new Uint8Array([Slatepack.VERSION]),new BigNumber(e.length).toBytes(BigNumber.BIG_ENDIAN,Uint16Array.BYTES_PER_ELEMENT),e]),i=Base58.encode(Common.mergeArrays([Base58.getChecksum(l),l]));i=Slatepack.format(i),i=Slatepack.BINARY_HEADER+i+Slatepack.BINARY_FOOTER,T(i)}))}static get ENCRYPTED_DATA_NONCE_INDEX(){return 0}static get ENCRYPTED_DATA_DATA_INDEX(){return Slatepack.ENCRYPTED_DATA_NONCE_INDEX+1}static get NO_SECRET_KEY(){return null}static get ADDRESS_LENGTH(){return Slatepack.ADDRESS_WITHOUT_HUMAN_READABLE_PART_LENGTH+Consensus.SLATEPACK_ADDRESS_HUMAN_READABLE_PART.length}static encrypt(e,E,t){return new Promise((function(r,a){var _=X25519.secretKeyFromEd25519SecretKey(e);if(_!==X25519.OPERATION_FAILED){var n=X25519.publicKeyFromEd25519PublicKey(E);if(n===X25519.OPERATION_FAILED)return _.fill(0),void a("Invalid public key.");var N=X25519.sharedSecretKeyFromSecretKeyAndPublicKey(_,n);if(N===X25519.OPERATION_FAILED)_.fill(0),a("Creating shared secret key failed.");else if(_.fill(0),!1===Common.arraysAreEqual(N,new Uint8Array(N.length).fill(0)))if(0!==t.length){var T=new Uint8Array(Slatepack.NONCE_LENGTH);crypto.getRandomValues(T);try{var c=chacha.createCipher(N,T);c.setAAD(Slatepack.AAD_VALUE);var l=c.update(t);c.end();var i=c.getAuthTag();l=Common.mergeArrays([l,i])}catch(e){return N.fill(0),void a("Encrypting data failed.")}N.fill(0),r([T,l])}else N.fill(0),a("Invalid data.");else N.fill(0),a("Invalid shared secret key")}else a("Invalid secret key.")}))}static decrypt(e,E,t,r){return new Promise((function(a,_){var n=X25519.secretKeyFromEd25519SecretKey(e);if(n!==X25519.OPERATION_FAILED){var N=X25519.publicKeyFromEd25519PublicKey(E);if(N===X25519.OPERATION_FAILED)return n.fill(0),void _("Invalid public key.");var T=X25519.sharedSecretKeyFromSecretKeyAndPublicKey(n,N);if(T===X25519.OPERATION_FAILED)n.fill(0),_("Creating shared secret key failed.");else if(n.fill(0),!1===Common.arraysAreEqual(T,new Uint8Array(T.length).fill(0)))if(t.length>Slatepack.TAG_LENGTH){try{var c=chacha.createDecipher(T,r);c.setAAD(Slatepack.AAD_VALUE),c.setAuthTag(t.subarray(t.length-Slatepack.TAG_LENGTH));var l=c.update(t.subarray(0,t.length-Slatepack.TAG_LENGTH));c.end()}catch(e){return T.fill(0),void _("Decrypting data failed.")}T.fill(0),a(l)}else T.fill(0),_("Invalid encrypted data.");else T.fill(0),_("Invalid shared secret key")}else _("Invalid secret key.")}))}static format(e){for(var E="",t=0;t<e.length;++t)0!==t&&t%Slatepack.WORD_LENGTH==0&&(t%(Slatepack.WORD_LENGTH*Slatepack.WORDS_PER_LINE)==0?E+="\n":E+=" "),E+=e[t];return E}static get NONCE_LENGTH(){return 12}static get TAG_LENGTH(){return 16}static get AAD_VALUE(){return new Uint8Array([])}static get WORD_LENGTH(){return 15}static get WORDS_PER_LINE(){return 200}static get VERSION(){return 0}static get COMPONENT_SEPARATOR(){return"."}static get ENCRYPTED_HEADER(){return"BEGINSLATEPACK"+Slatepack.COMPONENT_SEPARATOR+" "}static get ENCRYPTED_FOOTER(){return Slatepack.COMPONENT_SEPARATOR+" ENDSLATEPACK"+Slatepack.COMPONENT_SEPARATOR}static get BINARY_HEADER(){return"BEGINSLATE_BIN"+Slatepack.COMPONENT_SEPARATOR+" "}static get BINARY_FOOTER(){return Slatepack.COMPONENT_SEPARATOR+" ENDSLATE_BIN"+Slatepack.COMPONENT_SEPARATOR}static get ENCRYPTED_HEADER_PATTERN(){return/^[>\n\r\t ]*BEGINSLATEPACK[>\n\r\t ]*$/u}static get ENCRYPTED_FOOTER_PATTERN(){return/^[>\n\r\t ]*ENDSLATEPACK[>\n\r\t ]*$/u}static get BINARY_HEADER_PATTERN(){return/^[>\n\r\t ]*BEGINSLATE_BIN[>\n\r\t ]*$/u}static get BINARY_FOOTER_PATTERN(){return/^[>\n\r\t ]*ENDSLATE_BIN[>\n\r\t ]*$/u}static get WHITESPACE_PATTERN(){return/[>\n\r\t ]/gu}static get NO_PUBLIC_KEY(){return null}static get ADDRESS_WITHOUT_HUMAN_READABLE_PART_LENGTH(){return 59}}module.exports=Slatepack;