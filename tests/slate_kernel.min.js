"use strict";class SlateKernel{constructor(e,t,r,s,i,n){if(this.reset(),!0===Object.isObject(e)){var a=e,E=t,g=r;this.unserialize(a,E,g)}else{var l=e,S=t,_=r;if(this.features=l,this.fee=S,this.lockHeight=_,this.relativeHeight=s,this.excess=i,this.excessSignature=n,!0===this.isComplete()&&!1===this.verifyExcessSignature())throw"Unsupported kernel."}}serialize(e){switch((e instanceof Slate==!0?e.getVersion():e).toFixed()){case Slate.VERSION_TWO.toFixed():case Slate.VERSION_THREE.toFixed():var t={features:SlateKernel.featuresToText(this.getFeatures()),excess_sig:Common.toHexString(this.getExcessSignature()),excess:Common.toHexString(this.getExcess())};switch(this.getFeatures()){case SlateKernel.COINBASE_FEATURES:t.fee=new BigNumber(0).toFixed(),t.lock_height=Slate.NO_LOCK_HEIGHT.toFixed();break;case SlateKernel.PLAIN_FEATURES:t.fee=this.getFee().toFixed(),t.lock_height=Slate.NO_LOCK_HEIGHT.toFixed();break;case SlateKernel.HEIGHT_LOCKED_FEATURES:t.fee=this.getFee().toFixed(),t.lock_height=this.getLockHeight().toFixed();break;case SlateKernel.NO_RECENT_DUPLICATE_FEATURES:t.fee=this.getFee().toFixed(),t.relative_height=this.getRelativeHeight().toFixed()}return t;default:throw"Unsupported slate version."}}getTransaction(){var e={excess_sig:Common.toHexString(this.getExcessSignature()),excess:Common.toHexString(this.getExcess())};switch(this.getFeatures()){case SlateKernel.COINBASE_FEATURES:e.features={[SlateKernel.featuresToText(this.getFeatures())]:{}};break;case SlateKernel.PLAIN_FEATURES:e.features={[SlateKernel.featuresToText(this.getFeatures())]:{fee:this.getFee()}};break;case SlateKernel.HEIGHT_LOCKED_FEATURES:e.features={[SlateKernel.featuresToText(this.getFeatures())]:{fee:this.getFee(),lock_height:this.getLockHeight()}};break;case SlateKernel.NO_RECENT_DUPLICATE_FEATURES:e.features={[SlateKernel.featuresToText(this.getFeatures())]:{fee:this.getFee(),relative_height:this.getRelativeHeight()}}}return e}getFeatures(){return this.features}getFee(){return this.fee}getLockHeight(){return this.lockHeight}getRelativeHeight(){return this.relativeHeight}getExcessSignature(){return this.excessSignature}setExcessSignature(e){return this.excessSignature=e,!0!==this.isComplete()||!1!==this.verifyExcessSignature()}getExcess(){return this.excess}setExcess(e){this.excess=e}isPlain(){return this.getFeatures()===SlateKernel.PLAIN_FEATURES}isCoinbase(){return this.getFeatures()===SlateKernel.COINBASE_FEATURES}isHeightLocked(){return this.getFeatures()===SlateKernel.HEIGHT_LOCKED_FEATURES}isNoRecentDuplicate(){return this.getFeatures()===SlateKernel.NO_RECENT_DUPLICATE_FEATURES}getHash(){switch(this.getFeatures()){case SlateKernel.COINBASE_FEATURES:return new Hash([new Uint8Array([this.getFeatures()]),new Uint8Array(new BigNumber(0).toBytes(BigNumber.BIG_ENDIAN,Common.BYTES_IN_A_UINT64)),new Uint8Array(Slate.NO_LOCK_HEIGHT.toBytes(BigNumber.BIG_ENDIAN,Common.BYTES_IN_A_UINT64)),this.getExcess(),this.getExcessSignature()]);case SlateKernel.PLAIN_FEATURES:return new Hash([new Uint8Array([this.getFeatures()]),new Uint8Array(this.getFee().toBytes(BigNumber.BIG_ENDIAN,Common.BYTES_IN_A_UINT64)),new Uint8Array(Slate.NO_LOCK_HEIGHT.toBytes(BigNumber.BIG_ENDIAN,Common.BYTES_IN_A_UINT64)),this.getExcess(),this.getExcessSignature()]);case SlateKernel.HEIGHT_LOCKED_FEATURES:return new Hash([new Uint8Array([this.getFeatures()]),new Uint8Array(this.getFee().toBytes(BigNumber.BIG_ENDIAN,Common.BYTES_IN_A_UINT64)),new Uint8Array(this.getLockHeight().toBytes(BigNumber.BIG_ENDIAN,Common.BYTES_IN_A_UINT64)),this.getExcess(),this.getExcessSignature()]);case SlateKernel.NO_RECENT_DUPLICATE_FEATURES:return new Hash([new Uint8Array([this.getFeatures()]),new Uint8Array(this.getFee().toBytes(BigNumber.BIG_ENDIAN,Common.BYTES_IN_A_UINT64)),new Uint8Array(this.getRelativeHeight().toBytes(BigNumber.BIG_ENDIAN,Common.BYTES_IN_A_UINT64)),this.getExcess(),this.getExcessSignature()])}}isEqualTo(e){return this.getFeatures()===e.getFeatures()&&(!1!==this.getFee().isEqualTo(e.getFee())&&(!1!==this.getLockHeight().isEqualTo(e.getLockHeight())&&(!(this.getRelativeHeight()===SlateKernel.NO_RELATIVE_HEIGHT&&e.getRelativeHeight()!==SlateKernel.NO_RELATIVE_HEIGHT||this.getRelativeHeight()!==SlateKernel.NO_RELATIVE_HEIGHT&&e.getRelativeHeight()===SlateKernel.NO_RELATIVE_HEIGHT||this.getRelativeHeight()!==SlateKernel.NO_RELATIVE_HEIGHT&&!1===this.getRelativeHeight().isEqualTo(e.getRelativeHeight()))&&(!1!==Common.arraysAreEqual(this.getExcessSignature(),e.getExcessSignature())&&!1!==Common.arraysAreEqual(this.getExcess(),e.getExcess())))))}isComplete(){return!1===Common.arraysAreEqual(this.getExcessSignature(),SlateKernel.ZERO_EXCESS_SIGNATURE)}static signatureMessage(e,t=new BigNumber(0),r=Slate.NO_LOCK_HEIGHT,s=SlateKernel.NO_RELATIVE_HEIGHT){switch(e){case SlateKernel.COINBASE_FEATURES:var i=new Uint8Array([e]);break;case SlateKernel.PLAIN_FEATURES:i=Common.mergeArrays([new Uint8Array([e]),new Uint8Array(t.toBytes(BigNumber.BIG_ENDIAN,Common.BYTES_IN_A_UINT64))]);break;case SlateKernel.HEIGHT_LOCKED_FEATURES:i=Common.mergeArrays([new Uint8Array([e]),new Uint8Array(t.toBytes(BigNumber.BIG_ENDIAN,Common.BYTES_IN_A_UINT64)),new Uint8Array(r.toBytes(BigNumber.BIG_ENDIAN,Common.BYTES_IN_A_UINT64))]);break;case SlateKernel.NO_RECENT_DUPLICATE_FEATURES:i=Common.mergeArrays([new Uint8Array([e]),new Uint8Array(t.toBytes(BigNumber.BIG_ENDIAN,Common.BYTES_IN_A_UINT64)),new Uint8Array(s.toBytes(BigNumber.BIG_ENDIAN,Common.BYTES_IN_A_UINT64))])}return Crypto.signatureMessage(i)}static featuresToText(e){switch(e){case SlateKernel.PLAIN_FEATURES:return"Plain";case SlateKernel.COINBASE_FEATURES:return"Coinbase";case SlateKernel.HEIGHT_LOCKED_FEATURES:return"HeightLocked";case SlateKernel.NO_RECENT_DUPLICATE_FEATURES:return"NoRecentDuplicate";default:return SlateKernel.UNSUPPORTED_FEATURES}}static get PLAIN_FEATURES(){return 0}static get COINBASE_FEATURES(){return SlateKernel.PLAIN_FEATURES+1}static get HEIGHT_LOCKED_FEATURES(){return SlateKernel.COINBASE_FEATURES+1}static get NO_RECENT_DUPLICATE_FEATURES(){return SlateKernel.HEIGHT_LOCKED_FEATURES+1}static get ZERO_EXCESS(){return new Uint8Array(Crypto.COMMIT_LENGTH).fill(0)}static get ZERO_EXCESS_SIGNATURE(){return new Uint8Array(Crypto.SINGLE_SIGNER_SIGNATURE_LENGTH).fill(0)}static get TRANSACTION_FEATURES_LENGTH(){return 1}reset(){this.features=SlateKernel.PLAIN_FEATURES,this.fee=new BigNumber(0),this.lockHeight=Slate.NO_LOCK_HEIGHT,this.relativeHeight=SlateKernel.NO_RELATIVE_HEIGHT,this.excessSignature=SlateKernel.ZERO_EXCESS_SIGNATURE,this.excess=SlateKernel.ZERO_EXCESS}unserialize(e,t,r){switch(t.getVersion().toFixed()){case Slate.VERSION_TWO.toFixed():case Slate.VERSION_THREE.toFixed():if("features"in e==!1||SlateKernel.textToFeatures(e.features)===SlateKernel.UNSUPPORTED_FEATURES||SlateKernel.textToFeatures(e.features)===SlateKernel.COINBASE_FEATURES)throw"Unsupported kernel.";switch(this.features=SlateKernel.textToFeatures(e.features),this.getFeatures()){case SlateKernel.PLAIN_FEATURES:if("fee"in e==!1||!1===Common.isNumberString(e.fee)&&e.fee instanceof BigNumber==!1||!1===new BigNumber(e.fee).isInteger()||!0===new BigNumber(e.fee).isNegative())throw"Unsupported kernel.";this.fee=new BigNumber(e.fee);break;case SlateKernel.HEIGHT_LOCKED_FEATURES:if("fee"in e==!1||!1===Common.isNumberString(e.fee)&&e.fee instanceof BigNumber==!1||!1===new BigNumber(e.fee).isInteger()||!0===new BigNumber(e.fee).isNegative())throw"Unsupported kernel.";if(this.fee=new BigNumber(e.fee),"lock_height"in e==!1||!1===Common.isNumberString(e.lock_height)&&e.lock_height instanceof BigNumber==!1||!1===new BigNumber(e.lock_height).isInteger()||!0===new BigNumber(e.lock_height).isLessThan(Slate.NO_LOCK_HEIGHT))throw"Unsupported kernel.";this.lockHeight=new BigNumber(e.lock_height);break;case SlateKernel.NO_RECENT_DUPLICATE_FEATURES:if(!0===Consensus.isNoRecentDuplicateKernelsEnabled(r))throw"Unsupported kernel.";if("fee"in e==!1||!1===Common.isNumberString(e.fee)&&e.fee instanceof BigNumber==!1||!1===new BigNumber(e.fee).isInteger()||!0===new BigNumber(e.fee).isNegative())throw"Unsupported kernel.";if(this.fee=new BigNumber(e.fee),"relative_height"in e==!1||!1===Common.isNumberString(e.relative_height)&&e.relative_height instanceof BigNumber==!1||!1===new BigNumber(e.relative_height).isInteger()||!0===new BigNumber(e.relative_height).isLessThan(Slate.MINIMUM_RECENT_HEIGHT)||!0===new BigNumber(e.relative_height).isGreaterThan(Slate.MAXIMUM_RECENT_HEIGHT))throw"Unsupported kernel.";this.relativeHeight=new BigNumber(e.relative_height)}if("excess_sig"in e==!1||!1===Common.isHexString(e.excess_sig))throw"Unsupported kernel.";if(this.excessSignature=Secp256k1Zkp.singleSignerSignatureFromData(Common.fromHexString(e.excess_sig)),this.getExcessSignature()===Secp256k1Zkp.OPERATION_FAILED)throw"Unsupported kernel.";if("excess"in e==!1||!1===Common.isHexString(e.excess)||Common.fromHexString(e.excess).length!==Crypto.COMMIT_LENGTH)throw"Unsupported kernel.";if(this.excess=Common.fromHexString(e.excess),!0===this.isComplete()&&!1===this.verifyExcessSignature())throw"Unsupported kernel.";break;default:throw"Unsupported kernel."}}verifyExcessSignature(){try{var e=SlateKernel.signatureMessage(this.getFeatures(),this.getFee(),this.getLockHeight(),this.getRelativeHeight())}catch(e){return!1}var t=Secp256k1Zkp.pedersenCommitToPublicKey(this.getExcess());return t!==Secp256k1Zkp.OPERATION_FAILED&&!1!==Secp256k1Zkp.verifySingleSignerSignature(this.getExcessSignature(),e,Secp256k1Zkp.NO_PUBLIC_NONCE,t,t,!1)}static textToFeatures(e){switch(e){case"Plain":return SlateKernel.PLAIN_FEATURES;case"Coinbase":return SlateKernel.COINBASE_FEATURES;case"HeightLocked":return SlateKernel.HEIGHT_LOCKED_FEATURES;case"NoRecentDuplicate":return SlateKernel.NO_RECENT_DUPLICATE_FEATURES;default:return SlateKernel.UNSUPPORTED_FEATURES}}static get UNSUPPORTED_FEATURES(){return SlateKernel.NO_RECENT_DUPLICATE_FEATURES+1}static get NO_RELATIVE_HEIGHT(){return null}static get MINIMUM_RECENT_HEIGHT(){return 1}static get MAXIMUM_RECENT_HEIGHT(){return Consensus.BLOCK_HEIGHT_WEEK}}